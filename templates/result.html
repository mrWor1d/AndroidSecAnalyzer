<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Resultados - DroidSecAnalyzer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f0fdf9;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #134e4a, #0d9488);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-logo .logo-text {
            font-size: 28px;
            font-weight: bold;
            color: #3DD9B3;
            letter-spacing: 4px;
        }

        .header-logo .logo-name {
            font-size: 14px;
            color: rgba(255,255,255,0.8);
        }

        .header-nav {
            display: flex;
            gap: 12px;
        }

        .btn-nav {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-size: 14px;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-nav svg {
            width: 18px;
            height: 18px;
        }

        .btn-secondary {
            color: #3DD9B3;
            background: rgba(61, 217, 179, 0.1);
            border: 1px solid rgba(61, 217, 179, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(61, 217, 179, 0.2);
            border-color: #3DD9B3;
        }

        .btn-primary {
            color: #134e4a;
            background: linear-gradient(135deg, #3DD9B3, #2dd4bf);
            border: none;
            box-shadow: 0 2px 8px rgba(61, 217, 179, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(61, 217, 179, 0.4);
        }

        .container {
            max-width: 900px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .risk-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            text-align: center;
        }

        .risk-card h1 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .risk-badge {
            display: inline-block;
            padding: 12px 40px;
            border-radius: 8px;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .risk-badge.ALTO { background: linear-gradient(135deg, #dc2626, #b91c1c); }
        .risk-badge.MEDIO { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .risk-badge.BAJO { background: linear-gradient(135deg, #10b981, #059669); }

        .metadata-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .metadata-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .app-icon {
            font-size: 40px;
            background: #f0fdf9;
            padding: 12px;
            border-radius: 12px;
        }

        .app-info {
            flex: 1;
        }

        .app-info h2 {
            color: #1e293b;
            font-size: 20px;
            margin-bottom: 4px;
        }

        .app-info .package {
            color: #64748b;
            font-size: 13px;
            font-family: monospace;
        }

        .risk-badge-small {
            padding: 8px 20px;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .risk-badge-small.ALTO { background: #dc2626; }
        .risk-badge-small.MEDIO { background: #f59e0b; }
        .risk-badge-small.BAJO { background: #10b981; }

        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .meta-item {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
        }

        .meta-label {
            display: block;
            font-size: 11px;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .meta-value {
            font-size: 14px;
            color: #1e293b;
            font-weight: 500;
        }

        .summary-card {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .summary-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
        }

        .summary-item {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .summary-item.high { background: #fef2f2; color: #dc2626; }
        .summary-item.medium { background: #fffbeb; color: #d97706; }
        .summary-item.low { background: #f0fdf4; color: #059669; }

        .severity-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .severity-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .severity-header:hover { background: #f8fafc; }

        .severity-header h2 {
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .severity-header .count {
            background: #e2e8f0;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
        }

        .severity-header.high { border-left: 4px solid #dc2626; }
        .severity-header.high h2 { color: #dc2626; }
        .severity-header.medium { border-left: 4px solid #f59e0b; }
        .severity-header.medium h2 { color: #d97706; }
        .severity-header.low { border-left: 4px solid #10b981; }
        .severity-header.low h2 { color: #059669; }

        .severity-header .toggle {
            font-size: 20px;
            color: #94a3b8;
            transition: transform 0.3s;
        }

        .severity-section.open .toggle { transform: rotate(180deg); }

        .severity-content {
            display: none;
            padding: 0 20px 20px;
        }

        .severity-section.open .severity-content { display: block; }

        .vuln-card {
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .vuln-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }

        .vuln-header:hover { background: #f1f5f9; }

        .vuln-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .vuln-title {
            font-weight: 600;
            color: #1e293b;
            font-size: 14px;
        }

        .category-badge {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .category-badge.permissions { background: #dbeafe; color: #1d4ed8; }
        .category-badge.network { background: #fce7f3; color: #be185d; }
        .category-badge.components { background: #e0e7ff; color: #4338ca; }
        .category-badge.config { background: #fef3c7; color: #b45309; }
        .category-badge.secrets { background: #fee2e2; color: #dc2626; }

        .vuln-meta {
            font-size: 12px;
            color: #64748b;
        }

        .vuln-toggle {
            color: #94a3b8;
            font-size: 18px;
            transition: transform 0.3s;
        }

        .vuln-card.open .vuln-toggle { transform: rotate(180deg); }

        .vuln-details {
            display: none;
            padding: 0 15px 15px;
            border-top: 1px solid #e2e8f0;
        }

        .vuln-card.open .vuln-details { display: block; }

        .detail-section {
            margin-top: 12px;
        }

        .detail-section h4 {
            font-size: 12px;
            color: #64748b;
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .detail-section p {
            font-size: 13px;
            color: #334155;
            line-height: 1.5;
        }

        .evidence-box {
            background: #1e293b;
            color: #e2e8f0;
            padding: 10px 12px;
            border-radius: 6px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            word-break: break-all;
        }

        .report-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .report-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid #e2e8f0;
        }

        .report-header:hover { background: #f8fafc; }

        .report-header h2 {
            font-size: 16px;
            color: #134e4a;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .report-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-download {
            background: linear-gradient(135deg, #3DD9B3, #0d9488);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-download:hover { opacity: 0.9; }

        .report-toggle {
            font-size: 20px;
            color: #94a3b8;
            transition: transform 0.3s;
        }

        .report-section.open .report-toggle { transform: rotate(180deg); }

        .report-content {
            display: none;
            padding: 20px;
            background: #1e293b;
            color: #e2e8f0;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .report-section.open .report-content { display: block; }

        .empty-section {
            text-align: center;
            padding: 20px;
            color: #94a3b8;
            font-size: 14px;
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-logo">
        <div class="logo-text">DSA</div>
        <div class="logo-name">DroidSecAnalyzer</div>
    </div>
    <div class="header-nav">
        <a href="/history" class="btn-nav btn-secondary">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Historial
        </a>
        <a href="/" class="btn-nav btn-primary">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Nuevo analisis
        </a>
    </div>
</div>

<div class="container">
    <!-- Metadata Card -->
    <div class="metadata-card">
        <div class="metadata-header">
            <div class="app-icon">ðŸ“±</div>
            <div class="app-info">
                <h2>{{ metadata.app_name }}</h2>
                <span class="package">{{ metadata.package }}</span>
            </div>
            <div class="risk-badge-small {{ risk }}">{{ risk }}</div>
        </div>
        <div class="metadata-grid">
            <div class="meta-item">
                <span class="meta-label">Version</span>
                <span class="meta-value">{{ metadata.version_name }} ({{ metadata.version_code }})</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Min SDK</span>
                <span class="meta-value">{{ metadata.min_sdk }}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Target SDK</span>
                <span class="meta-value">{{ metadata.target_sdk }}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">TamaÃ±o</span>
                <span class="meta-value">{{ metadata.file_size }}</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Permisos</span>
                <span class="meta-value">{{ metadata.permissions_total }} ({{ metadata.permissions_dangerous }} peligrosos)</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Componentes</span>
                <span class="meta-value">{{ metadata.activities }} Act / {{ metadata.services }} Svc / {{ metadata.receivers }} Rcv</span>
            </div>
        </div>
    </div>

    <!-- Summary Card -->
    <div class="summary-card">
        <div class="summary-bar">
            {% set high_count = results|selectattr('severity', 'equalto', 'HIGH')|list|length %}
            {% set medium_count = results|selectattr('severity', 'equalto', 'MEDIUM')|list|length %}
            {% set low_count = results|selectattr('severity', 'equalto', 'LOW')|list|length %}
            <span class="summary-item high">{{ high_count }} Alta</span>
            <span class="summary-item medium">{{ medium_count }} Media</span>
            <span class="summary-item low">{{ low_count }} Baja</span>
        </div>
    </div>

    {% set high_vulns = results|selectattr('severity', 'equalto', 'HIGH')|list %}
    {% if high_vulns %}
    <div class="severity-section open">
        <div class="severity-header high" onclick="toggleSection(this)">
            <h2>Severidad Alta <span class="count">{{ high_vulns|length }}</span></h2>
            <span class="toggle">â–¼</span>
        </div>
        <div class="severity-content">
            {% for v in high_vulns %}
            <div class="vuln-card">
                <div class="vuln-header" onclick="toggleCard(this)">
                    <div class="vuln-info">
                        <span class="category-badge {{ v.category }}">{{ v.category }}</span>
                        <span class="vuln-title">{{ v.title }}</span>
                    </div>
                    <div class="vuln-meta">{{ v.file }}</div>
                    <span class="vuln-toggle">â–¼</span>
                </div>
                <div class="vuln-details">
                    <div class="detail-section">
                        <h4>Descripcion</h4>
                        <p>{{ v.description }}</p>
                    </div>
                    <div class="detail-section">
                        <h4>Evidencia</h4>
                        <div class="evidence-box">{{ v.evidence }}</div>
                    </div>
                    <div class="detail-section">
                        <h4>Solucion</h4>
                        <p>{{ v.solution }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% set medium_vulns = results|selectattr('severity', 'equalto', 'MEDIUM')|list %}
    {% if medium_vulns %}
    <div class="severity-section open">
        <div class="severity-header medium" onclick="toggleSection(this)">
            <h2>Severidad Media <span class="count">{{ medium_vulns|length }}</span></h2>
            <span class="toggle">â–¼</span>
        </div>
        <div class="severity-content">
            {% for v in medium_vulns %}
            <div class="vuln-card">
                <div class="vuln-header" onclick="toggleCard(this)">
                    <div class="vuln-info">
                        <span class="category-badge {{ v.category }}">{{ v.category }}</span>
                        <span class="vuln-title">{{ v.title }}</span>
                    </div>
                    <div class="vuln-meta">{{ v.file }}</div>
                    <span class="vuln-toggle">â–¼</span>
                </div>
                <div class="vuln-details">
                    <div class="detail-section">
                        <h4>Descripcion</h4>
                        <p>{{ v.description }}</p>
                    </div>
                    <div class="detail-section">
                        <h4>Evidencia</h4>
                        <div class="evidence-box">{{ v.evidence }}</div>
                    </div>
                    <div class="detail-section">
                        <h4>Solucion</h4>
                        <p>{{ v.solution }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% set low_vulns = results|selectattr('severity', 'equalto', 'LOW')|list %}
    {% if low_vulns %}
    <div class="severity-section">
        <div class="severity-header low" onclick="toggleSection(this)">
            <h2>Severidad Baja <span class="count">{{ low_vulns|length }}</span></h2>
            <span class="toggle">â–¼</span>
        </div>
        <div class="severity-content">
            {% for v in low_vulns %}
            <div class="vuln-card">
                <div class="vuln-header" onclick="toggleCard(this)">
                    <div class="vuln-info">
                        <span class="category-badge {{ v.category }}">{{ v.category }}</span>
                        <span class="vuln-title">{{ v.title }}</span>
                    </div>
                    <div class="vuln-meta">{{ v.file }}</div>
                    <span class="vuln-toggle">â–¼</span>
                </div>
                <div class="vuln-details">
                    <div class="detail-section">
                        <h4>Descripcion</h4>
                        <p>{{ v.description }}</p>
                    </div>
                    <div class="detail-section">
                        <h4>Evidencia</h4>
                        <div class="evidence-box">{{ v.evidence }}</div>
                    </div>
                    <div class="detail-section">
                        <h4>Solucion</h4>
                        <p>{{ v.solution }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <div class="report-section">
        <div class="report-header" onclick="toggleReport(this)">
            <h2>Informe detallado</h2>
            <div class="report-actions">
                <a class="btn-download" href="/download" onclick="event.stopPropagation()">Descargar TXT</a>
                <span class="report-toggle">â–¼</span>
            </div>
        </div>
        <div class="report-content">{{ report }}</div>
    </div>
</div>

<script>
function toggleSection(header) {
    header.parentElement.classList.toggle('open');
}

function toggleCard(header) {
    header.parentElement.classList.toggle('open');
}

function toggleReport(header) {
    header.parentElement.classList.toggle('open');
}
</script>

</body>
</html>
